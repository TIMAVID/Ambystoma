---
title: "Atlas"
author: "David Ledesma"
date: "3/22/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	warning = TRUE,
	message = TRUE,
	comment = "##",
	prompt = FALSE,
	tidy = TRUE,
	tidy.opts = list(blank = FALSE, width.cutoff = 75),
	fig.path = "img/",
	fig.align = "center"
)
```

### Load in data ###

```{r}
library(curl)
library(readxl)
Amb_linear_data <- curl("https://raw.githubusercontent.com/TIMAVID/Ambystoma/master/Linear_data/Data/Amb_linear_data.csv")
Amb_linear_data <-  read.csv(Amb_linear_data)
```

### Tidy data

```{r, echo=FALSE}
library(dplyr)

Atlas <-  Amb_linear_data[c(1, 3, 9:14, 55:56)] #select only relevant atlas measurements
Atlas <- Atlas %>% dplyr::rename(M1 = 3, M2=4, M3=5,M4=6,M5=7,M6=8)# remame columns for easier manipulation

Atlas_wofossil <- dplyr::filter(Atlas, !grepl('41229*', species)) # remove fossils
Atlas_wofossil <- Atlas_wofossil[,-1]

Atlas_wofossil_noNA <- na.omit(Atlas_wofossil) # remove rows with N/A's

Atlas_wofossil_noNA$species<-as.factor(Atlas_wofossil_noNA$species)
Atlas_wofossil_noNA$species <- factor(Atlas_wofossil_noNA$species, levels = 
                                           c("A.gracile","A.talpoideum", "A.maculatum", "A.macrodactylum","A.opacum","A.jeffersonianum","A.laterale",
                                             "A.mabeei","A.texanum","A.annulatum","A.tigrinum","A.mavortium", "A.ordinarium", "A.subsalsum")) # Reorder species
```

## PCA's

```{r, echo=FALSE, message=F, warning=F}
library(factoextra)
library(psych)
library(devtools)
library(ggbiplot)
```
```{r}
Atlas.pca <- prcomp(Atlas_wofossil_noNA[c(1:7)], center = TRUE, scale = TRUE) # PCA

# Summary stats #
summary(Atlas.pca)
sd <- Atlas.pca$sdev
loadings <- Atlas.pca$rotation
rownames(loadings) <- colnames(Atlas[c(2:8)])
scores <- Atlas.pca$x

# Show variance explained by PC's #
var <- sd^2
varPercent <- var/sum(var) * 100
barplot(varPercent, xlab='PC', ylab='Percent Variance', names.arg=1:length(varPercent), las=1, ylim=c(0, max(varPercent)), col='gray')
abline(h=1/ncol(Atlas[c(2:8)])*100, col='red')

fviz_eig(Atlas.pca, xlab = "Principal Components")

#Show loadings #

loadings
sqrt(1/ncol(Atlas[c(2:8)])) # cutoff for 'important' loadings

# dev.new(height=7, width=7)
biplot(scores[, 1:2], loadings[, 1:2], cex=0.9)

ggbiplot(Atlas.pca, ellipse=FALSE, groups=Atlas_wofossil_noNA$species)

```

## Plot

```{r,echo=FALSE, message=F, warning=F}
library(ggplot2)
library(grid)
library(gridExtra)
library(randomcoloR)
library(ggfortify)
library(ggalt)
```

```{r}

scores <- as.data.frame(scores)
scores$species <- Atlas_wofossil_noNA$species # reattach species

theme<-theme(panel.background = element_blank(),panel.border=element_rect(fill=NA),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.background=element_blank(),axis.text.x=element_text(colour="black"),axis.text.y=element_text(colour="black"),axis.ticks=element_line(colour="black"),plot.margin=unit(c(1,1,1,1),"line"))

percentage <- paste(colnames(scores), "(", paste(as.character(round(varPercent)), "%", " )", sep="") )


n <- 14
palette <- distinctColorPalette(n)

p<-ggplot(scores,aes(x=PC1,y=PC2,color=`species` ))
p<-p+geom_point(size =5)+theme + xlab(percentage[1]) + ylab(percentage[2]) +scale_color_manual(values = palette)
# p + stat_ellipse()
p
#alternative plot
# fviz_pca_ind(Atlas.pca)
# fviz_pca_ind(Atlas.pca, label="none", habillage=Atlas_wofossil_noNA$species, addEllipses=TRUE, ellipse.level=0.95, palette = palette)
#alternative plot 2

autoplot(Atlas.pca, data = Atlas_wofossil_noNA, colour = 'species', frame = TRUE, label = TRUE) 
```

## No tuberculum interglenoideum ventral extent measurement

```{r}

Atlas_wofossil_noTub <- Atlas_wofossil[,-1] 
Atlas_wofossil_noTub <- na.omit(Atlas_wofossil_noTub) # remove rows with N/A's

Atlas_wofossil_noTub$species<-as.factor(Atlas_wofossil_noTub$species)
Atlas_wofossil_noTub$species <- factor(Atlas_wofossil_noTub$species, levels = 
                                        c("A.gracile","A.talpoideum", "A.maculatum", "A.macrodactylum","A.opacum","A.jeffersonianum","A.laterale",
                                          "A.mabeei","A.texanum","A.annulatum","A.tigrinum","A.mavortium", "A.ordinarium", "A.subsalsum")) # Reorder species

Atlas.pca_2 <- prcomp(Atlas_wofossil_noTub[c(1:6)], center = TRUE, scale = FALSE) # PCA
autoplot(Atlas.pca_2, data = Atlas_wofossil_noTub, colour = 'species', frame = TRUE, label = FALSE) 
```

# PCA with fossils #

```{r}
Atlas_fossil <- dplyr::filter(Atlas, grepl('41229*', species)) # fossils
Atlas_fossil <- subset(Atlas_fossil, select=-c(specimen_num, Specimen))
```



```{r}

Atlas_fossil_complete <- na.omit(Atlas_fossil) # remove rows with N/A's

Amb_fossil_PCA <- predict(Atlas.pca, Atlas_fossil_complete[,1:7])
Fossil_PC_scores <- as.data.frame(Amb_fossil_PCA)

Fossil_PC_scores <- cbind(Fossil_PC_scores, species= Atlas_fossil_complete$species)

All_PC_scores <- rbind(scores, Fossil_PC_scores) # create a new dataframe with the original PC scores and the PC scores of your fossil
tail(All_PC_scores)
pointsToLabel <- as.character(Atlas_fossil_complete$species)
```

```{r}
species <- c("A.gracile","A.talpoideum", "A.maculatum", "A.macrodactylum","A.opacum","A.jeffersonianum","A.laterale",
             "A.mabeei","A.texanum","A.annulatum","A.tigrinum","A.mavortium", "A.ordinarium", "A.subsalsum")



pcaplot <- ggplot(data = All_PC_scores, mapping = aes(x = PC1, y = PC2,
                                                      col = species, label = species)) # creates the initial plot with datapoints color-coded and unique symbols by each species
pcaplot <- pcaplot + geom_encircle(expand=0, size = 2, data = All_PC_scores[!All_PC_scores$species %in% pointsToLabel,])+ theme_bw()
pcaplot <- pcaplot + 
  geom_text(aes(PC1, PC2, label = species), nudge_y = .003,
            check_overlap = FALSE, data = All_PC_scores[All_PC_scores$species %in% pointsToLabel,])+ geom_point(data = All_PC_scores[All_PC_scores$species %in% pointsToLabel,])

pcaplot <- pcaplot + scale_color_manual(breaks = c(species),
                                        values=c("black", "black", "#D5E25E", "#AA47E3" ,"#8E7BD9" ,"#D2A6D5" ,"#7AA9D2" ,"#78DDD0", "#CAE1AE", "#D7A79D", "#DAB059", "#75E555", "#79E194",
                                                 "#CDDADD", "#DC5956", "#E363BB"))
pcaplot

```

```{r}
# Tuberculum interglenoideum plot

library(EnvStats)
Tub_dat <- Atlas_wofossil_noNA[c(1,9)]
  
ventral_extension_p <- ggplot(data = Tub_dat, aes(x = species, y = (tub_interglen_extension)))
ventral_extension_p <- ventral_extension_p + geom_boxplot(na.rm = TRUE)
ventral_extension_p <- ventral_extension_p + theme(axis.text.x = element_text(angle = 90))
ventral_extension_p <- ventral_extension_p + ylab("ventral extension (mm)") + stat_n_text() +theme_classic()
ventral_extension_p
```

# Statistical Tests #

```{r}
#Removing 'A.laterale|A.talpoideum|A.subsalsum|A.ordinarium' due to low sample sizes#

Atlas_wofossil_noTub_sub <- dplyr::filter(Atlas_wofossil_noTub, !grepl('A.laterale|A.talpoideum|A.subsalsum|A.ordinarium', species))
Atlas_wofossil_noTub_sub$species <- factor(Atlas_wofossil_noTub_sub$species, levels = 
                                         c("A.gracile", "A.maculatum", "A.macrodactylum","A.opacum","A.jeffersonianum",
                                           "A.mabeei","A.texanum","A.annulatum","A.tigrinum","A.mavortium")) # Reorder species
```

```{r,echo=FALSE, message=F, warning=F}
library(tidyverse)
library(ggpubr)
library(rstatix)
library(car)
library(broom)
```

### Various ckecks for MANOVA ###

```{r}


# Atlas_wofossil_noTub_sub <- Atlas_wofossil_noTub_sub %>%
  # add_column(id = rownames(Atlas_wofossil_noTub_sub), .after = 8)

#Check sample sizes:PASS
Atlas_wofossil_noTub_sub %>%
  dplyr::group_by(species) %>%
  dplyr::summarise(N = n())

# Identify univariate outliers for each variable:FAIL
Atlas_wofossil_noTub_sub %>%
  dplyr::group_by(species) %>%
  identify_outliers(5) #input variable column here
Atlas_wofossil_noTub_sub %>%
  dplyr::group_by(species) %>%
  identify_outliers(6) #input variable column here
#...

#Detect multivariate outliers:MOSTLY PASS

head(mahalanobis_distance(Atlas_wofossil_noTub_sub[,1:6]))

#Check univariate normality assumption:FAIL
Atlas_wofossil_noTub_sub %>%
  group_by(species) %>%
  shapiro_test(M1, M2,M3,M4,M5,M6) %>%
  arrange(variable)

#Check Multivariate normality:FAIL
Atlas_wofossil_noTub_sub %>%
  dplyr::select(,1:6) %>%
  mshapiro_test()

#Identify multicollinearity:FAIL
Atlas_wofossil_noTub_sub %>% cor_test(,1:6)

# PROBLEM!!:Absence of multicollinearity. The dependent (outcome) variables cannot be too correlated to each other. No correlation should be above r = 0.90 [Tabachnick and Fidell (2012)}.
cor(Atlas_wofossil_noTub_sub[,1:6])
```

### MANOVA# :*Failed multiple checks

```{r}

Atlas.man <- manova(cbind(M1,M2,M3,M4,M5,M6) ~ species, data = Atlas_wofossil_noTub_sub)
summary(Atlas.man)
summary.aov(Atlas.man)
```

### Permutation MANOVA ## *Overcome failed checks

```{r,echo=FALSE, message=F, warning=F}
library(RVAideMemoire)
require(vegan)
```

```{r}
#Permutational Multivariate Analysis of Variance Using Distance Matrices
adonis(Atlas_wofossil_noTub_sub[,1:6]~species,data=Atlas_wofossil_noTub_sub,method="euclidean") 

#pairwise comparisons between group levels with corrections for multiple testing
pairwise.perm.manova(Atlas_wofossil_noTub_sub[,1:6],Atlas_wofossil_noTub_sub$species,nperm=50, progress = FALSE) #needs more permutation but takes a long time
#or using euclidean distances
AtlasPPM<-pairwise.perm.manova(dist(Atlas_wofossil_noTub_sub[,1:6],"euclidean"),Atlas_wofossil_noTub_sub$species,nperm=999)
AtlasPPM
```

### tuberculum interglenoideum measurement only

```{r}
Atlas_wofossil_Tub_only <- as.data.frame(Atlas_wofossil[c(1,8:9)]) 
Atlas_wofossil_Tub_only <- na.omit(Atlas_wofossil_Tub_only) # remove rows with N/A's
Atlas_wofossil_Tub_only$species<-as.factor(Atlas_wofossil_Tub_only$species)
Atlas_wofossil_Tub_only$species <- factor(Atlas_wofossil_Tub_only$species, levels = 
                                             c("A.gracile", "A.maculatum", "A.macrodactylum","A.opacum","A.jeffersonianum",
                                               "A.mabeei","A.texanum","A.annulatum","A.tigrinum","A.mavortium")) # Reorder species


Atlas_wofossil_Tub_only <- dplyr::filter(Atlas_wofossil_Tub_only, !grepl('A.laterale|A.talpoideum|A.subsalsum|A.ordinarium', species))


#Permutational Anova
perm.anova(Atlas_wofossil_Tub_only$tub_interglen_extension ~ Atlas_wofossil_Tub_only$species, nperm=1000)

#pairwise comparisons between group levels with corrections for multiple testing
library(rcompanion)

PT <- pairwisePermutationTest(tub_interglen_extension ~   species,
                             data   = Atlas_wofossil_Tub_only,
                             method = "fdr")
PT

pairwise.perm.t.test(Atlas_wofossil_Tub_only$tub_interglen_extension,Atlas_wofossil_Tub_only$species,nperm=999,progress = FALSE)
```

# DFA #

```{r}
#PROBLEM:Check Multivariate normality:FAIL
mqqnorm(Atlas_wofossil_noTub_sub[,1:6], main = "Multi-normal Q-Q Plot")
```

```{r}
#DFA# With MASS

library(MASS)
AtlasLDA <- lda(species ~ M1 + M2 + M3 + M4 + M5 + M6, data=Atlas_wofossil_noTub_sub, CV = FALSE) #DFA no jacknife
AtlasLDA

AtlasLDA_jack <- lda(species ~ M1 + M2 + M3 + M4 + M5 + M6, data=Atlas_wofossil_noTub_sub, CV = TRUE) #DFA with jacknife

# Assess the accuracy of jacknife #

accAtlasLDA <- table(Atlas_wofossil_noTub_sub$species, AtlasLDA_jack$class)
accAtlasLDA
diag(prop.table(accAtlasLDA, 1))
sum(accAtlasLDA[row(accAtlasLDA) == col(accAtlasLDA)]) / sum(accAtlasLDA)

#DFA# With MORPHO

library(Morpho)
Atlascva=CVA(Atlas_wofossil_noTub_sub[,1:6], groups=Atlas_wofossil_noTub_sub$species, rounds = 10000, cv = TRUE)

barplot(Atlascva$Var[,2]) # Variance explained by the canonical roots

# get the typicality probabilities and resulting classifications
# all specimens with a probability of < 0.01 as outliers (assigned to no class)
typprobs <- typprobClass(Atlascva$CVscores,groups=Atlas_wofossil_noTub_sub$species, outlier = 0.01, cv = TRUE)
print(typprobs)

# Assess the accuracy of jacknife #

accJack <- table(Atlascva$groups, Atlascva$class)
accJack
diag(prop.table(accJack, 1))
sum(accJack[row(accJack) == col(accJack)]) / sum(accJack)
```

### Plot first two DF axes #

```{r}


AT_cva <- data.frame(Atlascva$CVscores, species = Atlascva$groups)

ggplot(AT_cva, aes(CV.1, CV.2)) +
  geom_point(size =5,aes(color = species)) + theme_classic() + scale_color_brewer(palette="Paired")
#alternative plot
plot(Atlascva$CVscores, col=Atlas_wofossil_noTub_sub$species, pch=as.numeric(Atlas_wofossil_noTub_sub$species), typ="n",asp=1,
     xlab=paste("1st canonical axis", paste(round(Atlascva$Var[1,2],1),"%")),
     ylab=paste("2nd canonical axis", paste(round(Atlascva$Var[2,2],1),"%")))
text(Atlascva$CVscores, as.character(Atlas_wofossil_noTub_sub$species), col=as.numeric(Atlas_wofossil_noTub_sub$species), cex=.7)
```

### Plot Mahalahobis distances as dendrogram #

```{r}
dendroS=hclust(Atlascva$Dist$GroupdistMaha)
dendroS$labels=levels(Atlas_wofossil_noTub_sub$species)
par(mar=c(6.5,4.5,1,1))
dendroS=as.dendrogram(dendroS)
plot(dendroS, main='',sub='', xlab="",
     ylab='Mahalahobis distance')
```

# Random Forest ###:Non-parametric

```{r}
library(randomForest)

Atlas.rf <- randomForest(species ~ M1 + M2 + M3 + M4 + M5 + M6, data=Atlas_wofossil_noTub_sub, importance=TRUE,
                         proximity=TRUE)
print(Atlas.rf)
rf_acc <- Atlas.rf$confusion
rf_acc <- 1-rf_acc[,11] # percent correct classification
rf_acc
# Look at variable importance
round(importance(Atlas.rf), 2)
varImpPlot(Atlas.rf)
```

# K Nearest neighbor ###:Non-parametric

```{r}
library(tidyverse)
library(caret)

Atlas_wofossil_noTub_sub <- column_to_rownames(Atlas_wofossil_noTub_sub, var = "specimen_num")

#make KNN model using LOOCV to find optimal k
KNNmodel <- train(
  species ~., data = Atlas_wofossil_noTub_sub, method = "knn",
  trControl = trainControl("LOOCV", number =1),
  preProcess = c("center"), #center the data
  tuneLength = 15)

plot(KNNmodel) # plot accuracy vs k
KNNmodel$bestTune # optimal k

predicted.classes <- KNNmodel %>% predict(Atlas_wofossil_noTub_sub[,1:6]) # predict class based on KNN model
head(predicted.classes)
mean(predicted.classes == Atlas_wofossil_noTub_sub$species) #overall accuracy

# assess accuracy per species
accKNN <- table(Atlas_wofossil_noTub_sub$species,predicted.classes)
accKNN
diag(prop.table(accKNN, 1))
```

# Model selection (multinominal regression) 


```{r,echo=T, message=FALSE, results='hide'}

library(glmulti)

library(nnet)

multinom.glmulti <- function(formula, data, ...)
  multinom(formula, data, ...)

res <- glmulti(species ~ .,level=1, data=Atlas_wofossil_noTub_sub, report = FALSE, plotty = FALSE,fitfunction=multinom.glmulti, method = "h", crit="aic", confsetsize=16)
```

```{r}

print(res)

plot(res)

top <- weightable(res)
top

```
